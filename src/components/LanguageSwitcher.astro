---
import { siteConfig, type Locale } from '@/config/site';
import { languages } from '@/i18n/languages';
import { t } from '@/i18n/ui';

interface Props {
  currentLocale: Locale;
  currentPath?: string;
}

const { currentLocale, currentPath = '' } = Astro.props;
const currentLang = languages[currentLocale];

function getLocalizedPath(locale: Locale): string {
  const pathWithoutLocale = currentPath.replace(/^\/[a-z]{2}(-[A-Z]{2})?/, '');
  return `/${locale}${pathWithoutLocale || '/'}`;
}
---

<div class="relative group">
  <button 
    type="button"
    class="flex items-center gap-2 px-3 py-2 rounded-lg bg-[var(--color-surface-elevated)] border border-[var(--color-border)] hover:border-[var(--color-accent)] transition-colors text-sm"
    aria-haspopup="listbox"
    aria-expanded="false"
  >
    <span class="text-base">{currentLang.flag}</span>
    <span class="hidden sm:inline">{currentLang.nativeName}</span>
    <svg class="w-4 h-4 opacity-60" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
    </svg>
  </button>

  <div class="absolute right-0 top-full mt-2 w-48 py-2 rounded-lg bg-[var(--color-surface)] border border-[var(--color-border)] shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
    <div class="px-3 py-2 text-xs font-semibold uppercase tracking-wider text-[var(--color-accent)] border-b border-[var(--color-border)]">
      {t('language', currentLocale)}
    </div>
    <ul role="listbox" class="py-1">
      {siteConfig.locales.map((locale) => {
        const lang = languages[locale];
        const isActive = locale === currentLocale;
        return (
          <li role="option" aria-selected={isActive}>
            <a
              href={getLocalizedPath(locale)}
              class:list={[
                'flex items-center gap-3 px-3 py-2 text-sm transition-colors',
                isActive 
                  ? 'bg-[var(--color-accent)] text-[var(--color-ink)]' 
                  : 'hover:bg-[var(--color-surface-elevated)] text-[var(--color-paper)]'
              ]}
            >
              <span class="text-base">{lang.flag}</span>
              <span>{lang.nativeName}</span>
              {isActive && (
                <svg class="w-4 h-4 ml-auto" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
              )}
            </a>
          </li>
        );
      })}
    </ul>
  </div>
</div>
